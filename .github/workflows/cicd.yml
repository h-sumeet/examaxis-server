name: CI-CD

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  # âœ… CI: lint, test, build
  lint-test-build:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” Run lint
        run: npm run lint

      - name: ðŸ§ª Run tests
        run: npm test

      - name: ðŸ—ï¸ Build project
        run: npm run build

  # ðŸš€ CD: deploy only after CI passes
  deploy:
    needs: lint-test-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: ðŸ§¾ Add VPS to known_hosts
        run: |
          ssh-keyscan 82.25.104.1 >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to VPS
        run: |
          ssh -i ~/.ssh/id_rsa root@82.25.104.1 << 'EOF'
            cd /root/apps/credlock

            echo "Pulling latest changes..."
            git pull origin main

            echo "Installing dependencies..."
            npm install --production

            echo "Building project..."
            npm run build

            pm2 start "npm run start" --name credlock || pm2 restart credlock
            pm2 save
          EOF
